<div class="w-full">
  <!-- Task Filters -->
  <app-task-filters 
    [users]="users" 
    (filtersChange)="onFiltersChange($event)">
  </app-task-filters>

  <!-- Loading State -->
  <div *ngIf="isLoading" class="flex justify-center items-center py-12">
    <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-indigo-600"></div>
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4" role="alert">
    <p class="font-bold">Error</p>
    <p>{{ error }}</p>
  </div>

  <!-- Viewer Notice -->
  <div *ngIf="!(canUpdateTasks$ | async)" class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-4" role="alert">
    <p class="font-bold">Viewer Mode</p>
    <p>You can move task cards between columns, but only admins and owners can create, edit, or delete tasks.</p>
  </div>

  <!-- Kanban Board Columns -->
  <div *ngIf="!isLoading && !error" class="grid grid-cols-3 gap-6" cdkDropListGroup>
    
    <!-- "To Do" Column -->
    <div class="p-4">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-gray-900">To Do</h2>
        <span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded-full">
          {{ todoTasks.length }}
        </span>
      </div>
      <div 
        cdkDropList 
        [id]="TaskStatus.OPEN"
        [cdkDropListData]="todoTasks"
        [cdkDropListConnectedTo]="[TaskStatus.IN_PROGRESS, TaskStatus.DONE]"
        (cdkDropListDropped)="drop($event)"
        class="min-h-[400px] space-y-3 p-2 border-2 border-dashed border-transparent hover:border-gray-300 transition-colors">
        <app-task-card 
          *ngFor="let task of todoTasks"
          [task]="task"
          [canEdit]="(canUpdateTasks$ | async) || false"
          [canDrag]="(canDragTasks$ | async) || false"
          (edit)="onEdit(task)"
          (delete)="onDelete(task.id)"
>
        </app-task-card>
        <div *ngIf="todoTasks.length === 0" class="text-center py-12 text-gray-400">
          <p class="text-sm">No tasks yet</p>
        </div>
      </div>
    </div>

    <!-- "In Progress" Column -->
    <div class="p-4">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-gray-900">In Progress</h2>
        <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">
          {{ inProgressTasks.length }}
        </span>
      </div>
      <div 
        cdkDropList
        [id]="TaskStatus.IN_PROGRESS"
        [cdkDropListData]="inProgressTasks"
        [cdkDropListConnectedTo]="[TaskStatus.OPEN, TaskStatus.DONE]"
        (cdkDropListDropped)="drop($event)"
        class="min-h-[400px] space-y-3 p-2 border-2 border-dashed border-transparent hover:border-gray-300 transition-colors">
        <app-task-card 
          *ngFor="let task of inProgressTasks"
          [task]="task"
          [canEdit]="(canUpdateTasks$ | async) || false"
          [canDrag]="(canDragTasks$ | async) || false"
          (edit)="onEdit(task)"
          (delete)="onDelete(task.id)"
>
        </app-task-card>
        <div *ngIf="inProgressTasks.length === 0" class="text-center py-12 text-gray-400">
          <p class="text-sm">No tasks in progress</p>
        </div>
      </div>
    </div>

    <!-- "Done" Column -->
    <div class="p-4">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-gray-900">Done</h2>
        <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">
          {{ doneTasks.length }}
        </span>
      </div>
      <div 
        cdkDropList
        [id]="TaskStatus.DONE"
        [cdkDropListData]="doneTasks"
        [cdkDropListConnectedTo]="[TaskStatus.OPEN, TaskStatus.IN_PROGRESS]"
        (cdkDropListDropped)="drop($event)"
        class="min-h-[400px] space-y-3 p-2 border-2 border-dashed border-transparent hover:border-gray-300 transition-colors">
        <app-task-card 
          *ngFor="let task of doneTasks"
          [task]="task"
          [canEdit]="(canUpdateTasks$ | async) || false"
          [canDrag]="(canDragTasks$ | async) || false"
          (edit)="onEdit(task)"
          (delete)="onDelete(task.id)"
>
        </app-task-card>
        <div *ngIf="doneTasks.length === 0" class="text-center py-12 text-gray-400">
          <p class="text-sm">No completed tasks</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State (if all lists are empty) -->
  <div *ngIf="!isLoading && !error && todoTasks.length === 0 && inProgressTasks.length === 0 && doneTasks.length === 0" class="text-center py-12">
    <p class="text-gray-500 text-lg">No tasks found. Create your first task!</p>
  </div>

  <!-- Modal with improved sizing -->
  <div *ngIf="showEditForm" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-8" (click)="onCancelEdit()">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-auto transform transition-all duration-300 ease-out max-h-[90vh] overflow-y-auto" (click)="$event.stopPropagation()">
        <!-- Modal content here -->
        <app-task-form [taskToEdit]="taskToEdit" (saveTask)="onSaveTask($event)" (cancel)="onCancelEdit()"></app-task-form>
    </div>
  </div>
</div>
