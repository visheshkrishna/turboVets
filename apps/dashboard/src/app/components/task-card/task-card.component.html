<!-- The cdkDrag directive makes this entire element draggable -->
<div cdkDrag [cdkDragData]="task" [attr.data-task-id]="task.id" class="bg-white p-4 rounded-lg shadow-sm mb-3 border border-gray-200 hover:shadow-md transition-shadow duration-200 cursor-move">
  
  <!-- This is an empty placeholder that will appear in the source list while dragging -->
  <div *cdkDragPlaceholder class="h-20 bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg"></div>

  <!-- Card Content -->
  <div class="flex justify-between items-start mb-3">
    <div class="flex-1">
      <h3 class="text-lg font-semibold text-gray-900 mb-1">{{ task.title }}</h3>
      <p class="text-sm text-gray-600 leading-relaxed mb-2">{{ task.description || 'No description provided.' }}</p>
      
      <!-- Task Details -->
      <div class="flex flex-wrap gap-4 mb-2">
        <!-- Priority -->
        <span [ngClass]="{
          'px-3 py-1 rounded-full text-xs font-medium flex items-center whitespace-nowrap': true,
          'bg-gray-100 text-gray-800': task.priority === 1,
          'bg-yellow-100 text-yellow-800': task.priority === 2,
          'bg-orange-100 text-orange-800': task.priority === 3,
          'bg-red-100 text-red-800': task.priority === 4,
          'bg-red-200 text-red-900': task.priority === 5
        }">
          <svg class="w-3 h-3 mr-1.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a1 1 0 00-1 1v3a1 1 0 11-2 0V6z" clip-rule="evenodd"></path>
          </svg>
          Priority {{ task.priority }}
        </span>
        
        <!-- Category -->
        <span [ngClass]="{
          'px-3 py-1 rounded-full text-xs font-medium flex items-center whitespace-nowrap': true,
          'bg-blue-100 text-blue-800': task.category === 'work',
          'bg-purple-100 text-purple-800': task.category === 'personal',
          'bg-red-100 text-red-800': task.category === 'urgent'
        }">
          <svg class="w-3 h-3 mr-1.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5c.256 0 .512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
          </svg>
          {{ task.category || 'uncategorized' }}
        </span>
      </div>
      
      <!-- Due Date -->
      <div *ngIf="task.dueDate" class="flex items-center text-xs text-gray-500 mb-2">
        <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
        </svg>
        Due: {{ formatDate(task.dueDate) }}
      </div>
    </div>
    
    <!-- Action buttons -->
    <div class="flex items-center space-x-2 ml-3">
      <!-- Drag handle indicator - shown for all users who can drag -->
      <div *ngIf="canDrag" class="cursor-move p-1.5 text-gray-400 hover:text-gray-600 transition-colors rounded">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
        </svg>
      </div>
      
      <!-- Edit and Delete buttons - only shown for users who can edit -->
      <div *ngIf="canEdit" class="flex items-center space-x-2">
        <!-- Edit button -->
        <button (click)="onEdit()" (mousedown)="$event.stopPropagation()" class="p-1.5 text-gray-400 hover:text-blue-600 rounded transition-colors hover:bg-blue-50 cursor-pointer">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z"></path>
          </svg>
        </button>
        
        <!-- Delete button -->
        <button (click)="onDelete()" (mousedown)="$event.stopPropagation()" class="p-1.5 text-gray-400 hover:text-red-600 rounded transition-colors hover:bg-red-50 cursor-pointer">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>
  
  <!-- Status badge -->
  <div class="flex justify-start">
    <span [ngClass]="{
      'px-3 py-1 rounded-full text-xs font-medium': true,
      'bg-yellow-100 text-yellow-800': task.status === TaskStatus.OPEN,
      'bg-blue-100 text-blue-800': task.status === TaskStatus.IN_PROGRESS,
      'bg-green-100 text-green-800': task.status === TaskStatus.DONE
    }">{{ task.status }}</span>
  </div>
</div>
